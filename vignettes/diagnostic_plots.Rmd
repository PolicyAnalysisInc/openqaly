---
title: "Diagnostic Plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Diagnostic Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette covers diagnostic visualizations for verifying model mechanics. The first section demonstrates transition matrix diagnostics using a purpose-built Markov model with tunnel states and shared state time.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(openqaly)

model <- define_model("markov") |>
  set_settings(
    n_cycles = 20,
    cycle_length = 1,
    cycle_length_unit = "years",
    discount_cost = 0.035,
    discount_outcomes = 0.035
  ) |>
  add_state(
    "stable",
    display_name = "Stable Disease",
    initial_prob = 1
  ) |>
  add_state(
    "progressed",
    display_name = "Progressed",
    state_group = "progression",
    share_state_time = TRUE,
    state_cycle_limit = 5,
    initial_prob = 0
  ) |>
  add_state(
    "progressed_comp",
    display_name = "Progressed (Complicated)",
    state_group = "progression",
    share_state_time = TRUE,
    initial_prob = 0
  ) |>
  add_state(
    "dead",
    display_name = "Dead",
    initial_prob = 0
  ) |>
  add_transition("stable", "progressed", 0.15) |>
  add_transition("stable", "dead", 0.02) |>
  add_transition("stable", "stable", C) |>
  add_transition("progressed", "progressed_comp", 0.10) |>
  add_transition("progressed", "dead", 0.05 + 0.03 * state_cycle) |>
  add_transition("progressed", "progressed", C) |>
  add_transition("progressed_comp", "progressed", 0.05) |>
  add_transition("progressed_comp", "dead", 0.08 + 0.04 * state_cycle) |>
  add_transition("progressed_comp", "progressed_comp", C) |>
  add_transition("dead", "dead", 1) |>
  add_value("cost", 1000, state = "stable", type = "cost") |>
  add_value("cost", 3000, state = "progressed", type = "cost") |>
  add_value("cost", 5000, state = "progressed_comp", type = "cost") |>
  add_value("cost", 0, state = "dead", type = "cost") |>
  add_value("qaly", 0.8, state = "stable", type = "outcome") |>
  add_value("qaly", 0.5, state = "progressed", type = "outcome") |>
  add_value("qaly", 0.3, state = "progressed_comp", type = "outcome") |>
  add_value("qaly", 0, state = "dead", type = "outcome") |>
  add_strategy("standard_care", "Standard Care") |>
  add_summary("total_cost", "cost", type = "cost") |>
  add_summary("total_qalys", "qaly", type = "outcome")

results <- run_model(model)
```

## Example Model

The diagnostic examples use a 4-state Markov model designed to illustrate tunnel states and shared state time:

- **Stable Disease** — starting state for all patients
- **Progressed** and **Progressed (Complicated)** — share state time via a common `"progression"` group, with a tunnel cap of 5 cycles
- **Dead** — absorbing state

Mortality in both progressed states increases with time spent in the progression group (`state_cycle`), and patients can move between the two progressed states without resetting the tunnel counter.

```{r, eval = FALSE}
model <- define_model("markov") |>
  set_settings(
    n_cycles = 20,
    cycle_length = 1,
    cycle_length_unit = "years",
    discount_cost = 0.035,
    discount_outcomes = 0.035
  ) |>
  add_state(
    "stable",
    display_name = "Stable Disease",
    initial_prob = 1
  ) |>
  add_state(
    "progressed",
    display_name = "Progressed",
    state_group = "progression",
    share_state_time = TRUE,
    state_cycle_limit = 5,
    initial_prob = 0
  ) |>
  add_state(
    "progressed_comp",
    display_name = "Progressed (Complicated)",
    state_group = "progression",
    share_state_time = TRUE,
    initial_prob = 0
  ) |>
  add_state(
    "dead",
    display_name = "Dead",
    initial_prob = 0
  ) |>
  add_transition("stable", "progressed", 0.15) |>
  add_transition("stable", "dead", 0.02) |>
  add_transition("stable", "stable", C) |>
  add_transition("progressed", "progressed_comp", 0.10) |>
  add_transition("progressed", "dead", 0.05 + 0.03 * state_cycle) |>
  add_transition("progressed", "progressed", C) |>
  add_transition("progressed_comp", "progressed", 0.05) |>
  add_transition("progressed_comp", "dead", 0.08 + 0.04 * state_cycle) |>
  add_transition("progressed_comp", "progressed_comp", C) |>
  add_transition("dead", "dead", 1) |>
  add_value("cost", 1000, state = "stable", type = "cost") |>
  add_value("cost", 3000, state = "progressed", type = "cost") |>
  add_value("cost", 5000, state = "progressed_comp", type = "cost") |>
  add_value("cost", 0, state = "dead", type = "cost") |>
  add_value("qaly", 0.8, state = "stable", type = "outcome") |>
  add_value("qaly", 0.5, state = "progressed", type = "outcome") |>
  add_value("qaly", 0.3, state = "progressed_comp", type = "outcome") |>
  add_value("qaly", 0, state = "dead", type = "outcome") |>
  add_strategy("standard_care", "Standard Care") |>
  add_summary("total_cost", "cost", type = "cost") |>
  add_summary("total_qalys", "qaly", type = "outcome")

results <- run_model(model)
```

## Transition Matrix Diagnostics

### Collapsed Transition Heatmap (Cycle 1)

The collapsed view shows the 4x4 transition matrix at cycle 1. At this point `state_cycle = 1`, so mortality from Progressed is `0.05 + 0.03 * 1 = 0.08` and from Progressed (Complicated) is `0.08 + 0.04 * 1 = 0.12`.

```{r, fig.width=9, fig.height=6}
transition_plot_heatmap(results, cycle = 1)
```

### Collapsed Transition Heatmap (Cycle 5)

By cycle 5, `state_cycle` has reached its cap of 5, so death probabilities are at their maximum: Progressed to Dead = `0.05 + 0.03 * 5 = 0.20`, Progressed (Complicated) to Dead = `0.08 + 0.04 * 5 = 0.28`.

```{r, fig.width=9, fig.height=6}
transition_plot_heatmap(results, cycle = 5)
```

### Collapsed Transition Table

The same data in tabular form for cycle 1.

```{r}
transition_matrix_table(results, cycle = 1)
```

### Expanded Transition Heatmap (Cycle 1)

Setting `collapsed = FALSE` reveals the internal tunnel states. This is the key diagnostic view for verifying tunnel routing:

- `progressed.1 -> progressed.2` — advances to the next tunnel index
- `progressed.5 -> progressed.5` — capped at the maximum, stays in place
- `progressed.2 -> progressed_comp.3` — shared state time means the complication state inherits the *next* tunnel index, not `.1`
- `progressed_comp.3 -> progressed.4` — returning from complications also advances the tunnel
- `progressed.5 -> progressed_comp.5` — both states stay at the cap

```{r, fig.width=9, fig.height=6}
transition_plot_heatmap(results, cycle = 1, collapsed = FALSE)
```

### Expanded Transition Heatmap (Cycle 5)

The same expanded view at cycle 5 shows how probabilities change while the routing structure remains identical.

```{r, fig.width=9, fig.height=6}
transition_plot_heatmap(results, cycle = 5, collapsed = FALSE)
```
