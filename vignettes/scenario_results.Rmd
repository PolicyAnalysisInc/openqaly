---
title: "Scenario Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Scenario Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates how to configure, run, and visualize scenario analysis using openqaly. Scenario analysis allows you to define named sets of parameter changes (scenarios) and compare their effects on model results. Unlike DSA which varies one parameter at a time, scenarios can change multiple parameters simultaneously to represent different clinical or economic assumptions.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 150
)
```

```{r setup, include = FALSE}
library(openqaly)

model <- read_model(system.file("models", "example_markov", package = "openqaly"))
```

## Defining Scenarios

Scenarios are defined using three functions:

- `add_scenario()` - Create a named scenario
- `add_scenario_variable()` - Override a variable value in a scenario
- `add_scenario_setting()` - Override a model setting in a scenario

### Creating Scenarios

```{r, eval = FALSE}
model <- model %>%
  add_scenario("Optimistic", description = "Best case clinical assumptions") %>%
  add_scenario("Pessimistic", description = "Conservative assumptions")
```

### Adding Variable Overrides

Each scenario can override one or more model variables:

```{r, eval = FALSE}
model <- model %>%
  add_scenario("Optimistic") %>%
  add_scenario_variable("Optimistic", "u_mild", 0.95) %>%
  add_scenario_variable("Optimistic", "u_severe", 0.75) %>%
  add_scenario_variable("Optimistic", "c_mild", 2000)
```

### Adding Setting Overrides

Scenarios can also override model settings like discount rates or timeframe:

```{r, eval = FALSE}
model <- model %>%
  add_scenario("Extended Horizon") %>%
  add_scenario_setting("Extended Horizon", "timeframe", 30) %>%
  add_scenario("No Discounting") %>%
  add_scenario_setting("No Discounting", "discount_cost", 0) %>%
  add_scenario_setting("No Discounting", "discount_outcomes", 0)
```

## Running Scenario Analysis

```{r, include = FALSE}
# Configure 8 scenarios for the examples
# Including scenarios designed to produce dominant/dominated outcomes
model <- model %>%
  # Scenario 1: Optimistic - better outcomes, lower costs
  add_scenario("Optimistic", description = "Best case assumptions") %>%
  add_scenario_variable("Optimistic", "u_mild", 0.92) %>%
  add_scenario_variable("Optimistic", "u_severe", 0.70) %>%
  add_scenario_variable("Optimistic", "c_mild", 1500) %>%
  add_scenario_variable("Optimistic", "c_severe", 6000) %>%
  # Scenario 2: Pessimistic - worse outcomes, higher costs
  add_scenario("Pessimistic", description = "Conservative assumptions") %>%
  add_scenario_variable("Pessimistic", "u_mild", 0.80) %>%
  add_scenario_variable("Pessimistic", "u_severe", 0.50) %>%
  add_scenario_variable("Pessimistic", "c_mild", 3500) %>%
  add_scenario_variable("Pessimistic", "c_severe", 12000) %>%
  # Scenario 3: High Efficacy - much better clinical outcomes
  add_scenario("High Efficacy", description = "Superior treatment response") %>%
  add_scenario_variable("High Efficacy", "u_mild", 0.95) %>%
  add_scenario_variable("High Efficacy", "u_severe", 0.80) %>%
  add_scenario_variable("High Efficacy", "hr_progression", 0.5) %>%
  # Scenario 4: Low Efficacy - reduced clinical benefit
  add_scenario("Low Efficacy", description = "Reduced treatment response") %>%
  add_scenario_variable("Low Efficacy", "u_mild", 0.78) %>%
  add_scenario_variable("Low Efficacy", "u_severe", 0.45) %>%
  add_scenario_variable("Low Efficacy", "hr_progression", 1.5) %>%
  # Scenario 5: High Cost - expensive treatment
  add_scenario("High Cost", description = "Premium pricing scenario") %>%
  add_scenario_variable("High Cost", "c_treatment", 15000) %>%
  add_scenario_variable("High Cost", "c_mild", 4000) %>%
  add_scenario_variable("High Cost", "c_severe", 15000) %>%
  # Scenario 6: Low Cost - budget pricing
  add_scenario("Low Cost", description = "Budget pricing scenario") %>%
  add_scenario_variable("Low Cost", "c_treatment", 2000) %>%
  add_scenario_variable("Low Cost", "c_mild", 1000) %>%
  add_scenario_variable("Low Cost", "c_severe", 4000) %>%
  # Scenario 7: Dominant - better outcomes AND lower costs
  add_scenario("Best Case", description = "Dominant scenario - better and cheaper") %>%
  add_scenario_variable("Best Case", "u_mild", 0.95) %>%
  add_scenario_variable("Best Case", "u_severe", 0.80) %>%
  add_scenario_variable("Best Case", "c_treatment", 1500) %>%
  add_scenario_variable("Best Case", "c_mild", 800) %>%
  add_scenario_variable("Best Case", "c_severe", 3000) %>%
  # Scenario 8: Dominated - worse outcomes AND higher costs
  add_scenario("Worst Case", description = "Dominated scenario - worse and more expensive") %>%
  add_scenario_variable("Worst Case", "u_mild", 0.70) %>%
  add_scenario_variable("Worst Case", "u_severe", 0.40) %>%
  add_scenario_variable("Worst Case", "c_treatment", 20000) %>%
  add_scenario_variable("Worst Case", "c_mild", 5000) %>%
  add_scenario_variable("Worst Case", "c_severe", 18000)
```

Use `run_scenario()` to execute the model for all defined scenarios:

```{r}
results <- run_scenario(model)
```

A "Base Case" scenario is automatically created, representing the model with default parameters. This is always the first scenario (scenario_id = 1).

### Viewing Scenario Metadata

The results include metadata describing each scenario:

```{r}
results$scenario_metadata
```

## Visualizing Results

### Outcomes Bar Charts

Use `scenario_outcomes_plot()` to create horizontal bar charts showing outcome values by scenario:

```{r, fig.width = 7, fig.height = 5}
scenario_outcomes_plot(results, "qalys")
```

#### Showing Differences

To show incremental outcomes (intervention minus comparator):

```{r, fig.width = 7, fig.height = 5}
scenario_outcomes_plot(results, "qalys", comparators = "volantor")
```

### Cost-Effectiveness Bar Charts

Use `scenario_ce_plot()` to display ICERs by scenario:

```{r, fig.width = 7, fig.height = 5}
scenario_ce_plot(results, "qalys", "costs", comparators = "volantor")
```

The CE bar chart handles edge cases:

- **Dominated**: Intervention is more costly and less effective (shown as red arrow)
- **Dominant**: Intervention is less costly and more effective (ICER = 0 or negative)
- **Equivalent**: Identical outcomes (undefined ICER)

In the plot above, you can see how different scenarios can lead to dominant outcomes (where the intervention provides better outcomes at lower cost) or dominated outcomes (worse outcomes at higher cost).

### Net Monetary Benefit Bar Charts

Use `scenario_nmb_plot()` to display incremental NMB by scenario:

```{r, fig.width = 7, fig.height = 5}
scenario_nmb_plot(results, "qalys", "costs",
                  comparators = "volantor", wtp = 50000)
```

## Tables

### Outcomes Table

```{r}
scenario_outcomes_table(results, "qalys")
```

### Cost-Effectiveness Table

The CE table shows incremental costs, outcomes, and ICERs for each scenario. This includes handling of dominated and dominant scenarios:

```{r}
scenario_ce_table(results, "qalys", "costs", comparators = "volantor")
```

### NMB Table

```{r}
scenario_nmb_table(results, "qalys", "costs",
                   comparators = "volantor", wtp = 50000)
```

## Value-Based Pricing in Scenarios

Scenario analysis can be combined with VBP analysis to show how the value-based price changes across scenarios.

### Running Scenario + VBP Analysis

Enable VBP by specifying the price variable, intervention strategy, and summary names:
```{r}
results_vbp <- run_scenario(
  model,
  vbp_price_variable = "c_treatment",
  vbp_intervention = "seritinib",
  vbp_outcome_summary = "qalys",
  vbp_cost_summary = "costs"
)
```

### VBP Bar Chart

```{r, fig.width = 7, fig.height = 5}
scenario_vbp_plot(results_vbp, wtp = 50000)
```

### VBP Table

```{r}
scenario_vbp_table(results_vbp, wtp = 50000)
```

### Calculating VBP Prices

Use `calculate_scenario_vbp_price()` to get the VBP at a specific WTP:

```{r}
# Base case VBP
calculate_scenario_vbp_price(results_vbp, wtp = 50000, scenario_name = "Base Case")

# Optimistic scenario VBP
calculate_scenario_vbp_price(results_vbp, wtp = 50000, scenario_name = "Optimistic")

# Best Case (dominant) scenario VBP
calculate_scenario_vbp_price(results_vbp, wtp = 50000, scenario_name = "Best Case")
```

## Working with Groups

When your model has multiple groups, you can view results by group:

### All Groups

```{r, fig.width = 7, fig.height = 6}
scenario_outcomes_plot(results, "qalys", groups = "all")
```

### Specific Groups

```{r, fig.width = 7, fig.height = 5}
scenario_outcomes_plot(results, "qalys", groups = "low_risk")
```

## Summary

Scenario analysis provides a flexible way to:

1. Define multiple parameter sets representing different assumptions
2. Compare outcomes, costs, and cost-effectiveness across scenarios
3. Identify dominant and dominated scenarios
4. Understand how VBP changes under different scenarios
5. Communicate uncertainty to stakeholders through clear visualizations

Key differences from DSA:

- DSA varies one parameter at a time systematically
- Scenario analysis allows bundled changes representing coherent alternatives
- Scenarios are named and described for clear communication
