---
title: "Deterministic Sensitivity Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deterministic Sensitivity Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates how to configure, run, and visualize deterministic sensitivity analysis (DSA) using openqaly. DSA varies one parameter at a time while holding others constant to assess the impact on model results. The examples use a sample model included with the package.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 150
)
```

```{r setup, include = FALSE}
library(openqaly)

model <- read_model(system.file("models", "example_markov", package = "openqaly"))
```

## Configuring DSA Parameters

Before running DSA, you must specify which parameters to vary and their bounds.

### Adding Variable Parameters

The `add_dsa_variable()` function defines model variables to include in DSA.

#### Basic usage with literal bounds

```{r, eval = FALSE}
model <- model %>%
  add_dsa_variable("c_severe", low = 5000, high = 12000)
```

#### Using the `bc` keyword for relative bounds

The `bc` keyword references the base case value, allowing relative variation.

```{r, eval = FALSE}
model <- model %>%
  add_dsa_variable("p_death_severe", low = bc * 0.5, high = bc * 2)
```

#### Custom display name

Use `display_name` to customize labels in plots and tables.

```{r, eval = FALSE}
model <- model %>%
  add_dsa_variable("p_mild", low = bc * 0.5, high = bc * 1.5,
                   display_name = "Disease Incidence")
```

### Adding Setting Parameters

The `add_dsa_setting()` function varies model settings like discount rates or timeframe.

#### Discount rate sensitivity

```{r, eval = FALSE}
model <- model %>%
  add_dsa_setting("discount_outcomes", low = 0, high = 5,
                  display_name = "Outcome Discount Rate")
```

#### Timeframe sensitivity

```{r, eval = FALSE}
model <- model %>%
  add_dsa_setting("timeframe", low = 5, high = 20)
```

## Running DSA

```{r, include = FALSE}
# Configure DSA parameters for the examples
# Note: Group-specific variables (p_mild, p_severe, p_death_severe) require
# specifying which group to vary. Global variables don't require this.
model <- model %>%
  add_dsa_variable("u_mild", low = bc * 0.8, high = bc * 1.2,
                   display_name = "Utility (Mild)") %>%
  add_dsa_variable("u_severe", low = bc * 0.5, high = bc * 1.5,
                   display_name = "Utility (Severe)") %>%
  add_dsa_variable("c_mild", low = bc * 0.8, high = bc * 1.2,
                   display_name = "Cost (Mild)") %>%
  add_dsa_variable("c_severe", low = bc * 0.8, high = bc * 1.2,
                   display_name = "Cost (Severe)") %>%
  add_dsa_variable("p_mild", low = bc * 0.5, high = bc * 1.5,
                   group = "low_risk", display_name = "Disease Incidence (Low Risk)") %>%
  add_dsa_variable("p_mild", low = bc * 0.5, high = bc * 1.5,
                   group = "high_risk", display_name = "Disease Incidence (High Risk)") %>%
  add_dsa_setting("discount_outcomes", low = 0, high = 5,
                  display_name = "Outcome Discount Rate")

dsa_results <- run_dsa(model)

# Additional DSA parameters for CE tornado plot examples
# These produce dominated and dominant ICER scenarios
model_ce <- model %>%
  add_dsa_variable("hr_progression", low = 0.1, high = 3.0,
                   display_name = "Progression HR", strategy = "volantor") %>%
  add_dsa_variable("c_treatment", low = bc * 0.1, high = bc * 5,
                   display_name = "Treatment Cost", strategy = "volantor")

dsa_ce_results <- run_dsa(model_ce)
```

The `run_dsa()` function executes the model for each parameter at its low and high bounds.

```{r, eval = FALSE}
dsa_results <- run_dsa(model)
```

## Tornado Plots

Tornado plots visualize the impact of each parameter on results, sorted by magnitude.

### Outcomes Tornado Plot

The `dsa_outcomes_plot()` function creates tornado plots for outcome summaries.

#### Basic usage

```{r, fig.width=7, fig.height=7}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys"
)
```

#### Filtering to specific strategies

```{r, fig.width=7, fig.height=6}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  strategies = c("seritinib", "volantor")
)
```

#### Intervention vs comparator

Use `interventions` and `comparators` to show incremental differences.

```{r, fig.width=7, fig.height=5}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  interventions = "volantor",
  comparators = "seritinib"
)
```

#### Hiding parameter values in labels

```{r, fig.width=7, fig.height=7}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  show_parameter_values = FALSE
)
```

#### Including zero-impact parameters

By default, parameters with no impact are excluded. Set `drop_zero_impact = FALSE` to include them.

```{r, fig.width=7, fig.height=7}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  drop_zero_impact = FALSE
)
```

#### Using discounted values

```{r, fig.width=7, fig.height=7}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  discounted = TRUE
)
```

#### By subgroup

Use `groups = 'all_groups'` to display results for each population subgroup separately.

```{r, fig.width=12, fig.height=10}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  groups = 'all_groups'
)
```

#### All groups with overall

Use `groups = 'all'` to display results for each subgroup plus the overall population.

```{r, fig.width=16, fig.height=12}
dsa_outcomes_plot(
  dsa_results,
  summary_name = "qalys",
  groups = 'all'
)
```

#### Same-side parameter variations

In rare cases, both the low and high parameter values may produce results on the same side of the base case result. When this occurs, both the "Low" and "High" bars extend in the same direction from the base case line rather than on opposite sides.

```{r, include = FALSE}
# Hidden setup - configure parameter where both low and high are above base case
model_same_side <- model %>%
  add_dsa_variable("u_severe", low = bc * 1.1, high = bc * 1.3,
                   display_name = "Severe Disease Utility (Both Above Base)")

dsa_same_side <- run_dsa(model_same_side)
```

```{r, fig.width=7, fig.height=7, echo = FALSE}
dsa_outcomes_plot(
  dsa_same_side,
  summary_name = "qalys"
)
```

### NMB Tornado Plot

The `dsa_nmb_plot()` function creates tornado plots for Net Monetary Benefit.

#### Intervention perspective

```{r, fig.width=7, fig.height=5}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor"
)
```

#### Comparator perspective

```{r, fig.width=7, fig.height=5}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  comparators = "seritinib"
)
```

#### Specific intervention vs comparator

```{r, fig.width=7, fig.height=5}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib"
)
```

#### Custom WTP override

```{r, fig.width=7, fig.height=5}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  wtp = 50000
)
```

#### By subgroup

```{r, fig.width=12, fig.height=6}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  groups = 'all_groups'
)
```

#### All groups with overall

```{r, fig.width=12, fig.height=10}
dsa_nmb_plot(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  groups = 'all'
)
```

## DSA Tables

### Outcomes Table

The `dsa_outcomes_table()` function presents DSA results in tabular format, showing low, base, and high values for each parameter.

#### Basic usage

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys"
)
```

#### Filtering to specific strategies

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  strategies = c("seritinib", "volantor")
)
```

#### Intervention perspective

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  interventions = "volantor"
)
```

#### Comparator perspective

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  comparators = "seritinib"
)
```

#### Custom decimal places

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "costs",
  decimals = 0
)
```

#### Using discounted values

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  discounted = TRUE
)
```

#### By subgroup

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  groups = 'all_groups'
)
```

#### All groups with overall

```{r}
dsa_outcomes_table(
  dsa_results,
  outcome = "qalys",
  groups = 'all'
)
```

### NMB Table

The `dsa_nmb_table()` function presents DSA Net Monetary Benefit results in tabular format, showing low, base, and high NMB values for each parameter.

#### Basic usage (intervention perspective)

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor"
)
```

#### Comparator perspective

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  comparators = "seritinib"
)
```

#### Specific intervention vs comparator

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib"
)
```

#### Custom WTP override

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  wtp = 50000
)
```

#### By subgroup

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  groups = 'all_groups'
)
```

#### All groups with overall

```{r}
dsa_nmb_table(
  dsa_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  groups = 'all'
)
```

### CE Tornado Plot

The `dsa_ce_plot()` function creates tornado plots showing the sensitivity of the Incremental Cost-Effectiveness Ratio (ICER) to variation in input parameters over specified ranges.

#### Basic usage

```{r, fig.width=7, fig.height=5}
dsa_ce_plot(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib"
)
```

The plot handles special ICER cases:

- **Dominated**: When the intervention has higher costs and lower/equal outcomes, the ICER is undefined (infinity). These are shown as arrow bars extending to the right edge of the plot.
- **Dominant**: When the intervention has lower costs and higher/equal outcomes, the ICER is zero. These are shown as bars extending to the zero line on the left.

### CE Table

The `dsa_ce_table()` function presents the sensitivity of the ICER to variation in input parameters in tabular format.

#### Basic usage

```{r}
dsa_ce_table(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib"
)
```

#### CE Plot by subgroup

Use `groups = 'all_groups'` to display CE results for each population subgroup separately.

```{r, fig.width=12, fig.height=8}
dsa_ce_plot(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib",
  groups = "all_groups"
)
```

#### CE Plot with all groups including overall

Use `groups = 'all'` to display results for each subgroup plus the overall population.

```{r, fig.width=16, fig.height=10}
dsa_ce_plot(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib",
  groups = "all"
)
```

#### CE Table by subgroup

```{r}
dsa_ce_table(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib",
  groups = "all_groups"
)
```

#### CE Table with all groups including overall

```{r}
dsa_ce_table(
  dsa_ce_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "volantor",
  comparators = "seritinib",
  groups = "all"
)
```

## Value-Based Pricing in DSA

Value-based pricing (VBP) analysis determines the maximum price an intervention can have while remaining cost-effective at a given willingness-to-pay (WTP) threshold. When combined with DSA, VBP analysis shows how parameter uncertainty affects the value-based price.

### Running DSA with VBP

To enable VBP analysis, pass additional parameters to `run_dsa()`:

- `vbp_price_variable`: The name of the variable representing the intervention's price
- `vbp_intervention`: The name of the intervention strategy

```{r, include = FALSE}
# Configure model for VBP analysis
# Note: The VBP price variable (c_treatment) should NOT be a DSA parameter
model_vbp <- model %>%
  add_dsa_variable("hr_progression", low = 0.1, high = 3.0,
                   display_name = "Progression HR", strategy = "volantor")

# Run DSA with VBP enabled
dsa_vbp_results <- run_dsa(
  model_vbp,
  vbp_price_variable = "c_treatment",
  vbp_intervention = "volantor",
  vbp_outcome_summary = "qalys",
  vbp_cost_summary = "costs"
)
```

```{r, eval = FALSE}
dsa_vbp_results <- run_dsa(
  model,
  vbp_price_variable = "c_treatment",
  vbp_intervention = "volantor",
  vbp_outcome_summary = "qalys",
  vbp_cost_summary = "costs"
)
```

### VBP Tornado Plot

The `dsa_vbp_plot()` function creates tornado plots showing how parameter variations affect the value-based price. By default, the WTP threshold is extracted from the outcome summary specified in the VBP analysis.

The `comparators` parameter controls which comparisons are shown:

- `"all"` (default): Shows each individual comparator plus "All Comparators" (minimum VBP)
- `"overall"`: Shows only the "All Comparators" aggregate
- `"all_comparators"`: Shows each individual comparator without the aggregate
- specific names: Shows only the specified comparator(s)

#### Default: all comparators + aggregate

By default, the plot shows each individual comparator plus an "All Comparators" aggregate facet:

```{r, fig.width=12, fig.height=5}
dsa_vbp_plot(dsa_vbp_results)
```

#### Aggregate only

Use `comparators = "overall"` to show only the "All Comparators" aggregate (minimum VBP across all comparators):

```{r, fig.width=7, fig.height=5}
dsa_vbp_plot(
  dsa_vbp_results,
  comparators = "overall"
)
```

#### Individual comparators only (no aggregate)

Use `comparators = "all_comparators"` to show each individual comparator without the aggregate:

```{r, fig.width=10, fig.height=5}
dsa_vbp_plot(
  dsa_vbp_results,
  comparators = "all_comparators"
)
```

#### Single comparator

Specify a comparator name to show only that comparison:

```{r, fig.width=7, fig.height=5}
dsa_vbp_plot(
  dsa_vbp_results,
  comparators = "seritinib"
)
```

#### Overriding the WTP threshold

You can specify a different WTP threshold using the `wtp` parameter:

```{r, fig.width=7, fig.height=5}
dsa_vbp_plot(
  dsa_vbp_results,
  wtp = 150000,
  comparators = "seritinib"
)
```

#### Hiding parameter values in labels

```{r, fig.width=7, fig.height=5}
dsa_vbp_plot(
  dsa_vbp_results,
  comparators = "seritinib",
  show_parameter_values = FALSE
)
```

#### All comparators by subgroup

```{r, fig.width=16, fig.height=8}
dsa_vbp_plot(
  dsa_vbp_results,
  groups = "all_groups"
)
```

#### All comparators with all groups

```{r, fig.width=20, fig.height=12}
dsa_vbp_plot(
  dsa_vbp_results,
  groups = "all"
)
```

### VBP Table

The `dsa_vbp_table()` function presents VBP sensitivity results in tabular format, showing how the value-based price varies with each parameter. Like the plot function, WTP defaults to the value from the outcome summary.

The `comparators` parameter follows the same pattern as the plot function.

#### Default: all comparators + aggregate

```{r}
dsa_vbp_table(dsa_vbp_results)
```

#### Aggregate only

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  comparators = "overall"
)
```

#### Individual comparators only (no aggregate)

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  comparators = "all_comparators"
)
```

#### Single comparator

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  comparators = "seritinib"
)
```

#### Overriding the WTP threshold

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  wtp = 150000,
  comparators = "seritinib"
)
```

#### All comparators by subgroup

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  groups = "all_groups"
)
```

#### All comparators with all groups

```{r}
dsa_vbp_table(
  dsa_vbp_results,
  groups = "all"
)
```
