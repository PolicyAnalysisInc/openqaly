---
title: "DSA Cost-Effectiveness Edge Cases"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DSA Cost-Effectiveness Edge Cases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 150
)
```

```{r setup, include = FALSE}
# Detect Environment
is_cran <- !identical(Sys.getenv("NOT_CRAN"), "true")
is_ci   <- identical(Sys.getenv("CI"), "true")

# If on CRAN or CI, stop rendering immediately
if (is_cran || is_ci) {
  message("Skipping vignette build on CRAN/CI")
  knitr::knit_exit()
}

library(openqaly)
```

A CE tornado plot shows how the ICER deviates from the base case when parameters are varied. To show these deviations, the base case must itself be representable on the plot—if it cannot be displayed, there is nothing for the bars to deviate from.

An ICER measures the cost per unit of health gained by choosing one strategy over another: ICER(A vs B) = (Cost_A - Cost_B) / (Outcome_A - Outcome_B). Critically, ICER(A vs B) and ICER(B vs A) are fundamentally different quantities that cannot be plotted on the same axis.

When comparing A vs B, the incremental cost and outcome define which quadrant of the cost-effectiveness plane you're in:

```
                      ΔCost (A - B)
                           |
           Dominated       |      Standard ICER
           (A less         |      (A costlier,
            effective,     |       more effective)
            costlier)      |
                           |
      ─────────────────────┼───────────────────── ΔOutcome (A - B)
                           |
           Reversed        |      Dominant
           (A cheaper,     |      (A cheaper,
            less           |       more effective)
            effective)     |
```

An "A vs B" ICER exists in the northeast (positive finite), northwest (dominated = ∞), and southeast (dominant = 0). In the southwest, ICER(A vs B) does not exist—choosing A loses QALYs, so "cost per QALY gained" is meaningless. The only valid ICER there is B vs A.

This means:

- If the base case is in NE/NW/SE, the plot shows A vs B as requested
- If the base case is in SW, the plot must flip to B vs A (indicated by asterisks and footnotes)
- If a parameter variation lands in SW while the base case is in NE/NW/SE, that bar cannot be drawn (the ICER is shown with an asterisk but no bar)
- If costs and outcomes are identical (origin), the ICER is undefined and cannot be displayed

The following examples demonstrate how each of these cases appears in practice.

## Edge Cases from a Standard Base Case

This section demonstrates all edge cases that can occur when the base case has a standard ICER (intervention costlier but more effective).

**Dominated**: When a parameter variation causes the intervention to become costlier and less effective, the arrow points toward infinity, representing that no WTP threshold would make this intervention cost-effective.

**Dominant**: When a variation causes the intervention to become cheaper and more effective, the bar reaches the zero line, representing that this intervention should be adopted regardless of WTP threshold.

**Direction change**: When a variation causes the intervention to become cheaper but less effective, the ICER flips direction (it would be B vs A, not A vs B). This cannot be displayed on the same axis as the base case. The plot shows the ICER value with an asterisk but does not draw a bar.

**Identical**: When a variation causes both strategies to have identical costs and outcomes, the ICER is undefined (0/0). The plot shows "Identical" with no bar.

```{r standard-model, include = FALSE}
# Standard base case: treatment costs more but is more effective
# DSA parameters produce all edge case types
#
# Key design: The sick state is very expensive (20000/cycle). Treatment reduces
# progression to sick state via tx_effect and has a cost adjustment via cost_adjust.

standard_model <- define_model("markov") %>%
  set_settings(
    n_cycles = 10, timeframe = 10, timeframe_unit = "years",
    cycle_length = 1, cycle_length_unit = "years"
  ) %>%
  add_strategy("control", "Standard Care") %>%
  add_strategy("treatment", "New Treatment") %>%
  add_state("healthy", initial_prob = 1) %>%
  add_state("sick", initial_prob = 0) %>%
  add_state("dead", initial_prob = 0) %>%

  # Disease progression
  add_variable("p_sick", 0.15) %>%
  add_variable("p_death", 0.03) %>%

  # Treatment effect on disease progression (multiplier - lower is better)
  add_variable("tx_effect", 1.0, strategy = "control") %>%
  add_variable("tx_effect", 0.5, strategy = "treatment") %>%

  # Treatment cost per cycle
  add_variable("c_treatment", 0, strategy = "control") %>%
  add_variable("c_treatment", 5000, strategy = "treatment") %>%

  # Cost adjustment factor - can make treatment cheaper
  add_variable("cost_adjust", 0, strategy = "control") %>%
  add_variable("cost_adjust", 0, strategy = "treatment") %>%

  # Factor that can make treatment identical to control
  add_variable("identical_factor", 0, strategy = "control") %>%
  add_variable("identical_factor", 0, strategy = "treatment") %>%

  # State costs - sick state is expensive (hospitalizations, etc.)
  add_variable("c_healthy", 500) %>%
  add_variable("c_sick", 20000) %>%
  add_variable("u_healthy", 0.9) %>%
  add_variable("u_sick", 0.5) %>%

  # DSA parameters

  # 1. Standard variation - stays in normal range
  add_dsa_variable("p_sick", low = 0.10, high = 0.25,
                   display_name = "Disease incidence") %>%

  # 2. Treatment effect: low=dominant, high=dominated
  add_dsa_variable("tx_effect", low = 0.1, high = 1.8,
                   display_name = "Treatment effect", strategy = "treatment") %>%

  # 3. Cost adjustment: at high values, treatment becomes cheaper but tx_effect
  #    stays at 0.5 (more effective), AND less effective (via the transition).
  #    This creates: cheaper + less effective = direction change (SW quadrant)
  add_dsa_variable("cost_adjust", low = 0, high = 1,
                   display_name = "Budget mode", strategy = "treatment") %>%

  # 4. Identical factor: at high values, makes treatment identical to control
  add_dsa_variable("identical_factor", low = 0, high = 1,
                   display_name = "Equivalence factor", strategy = "treatment") %>%

  # 5. Cost of illness - affects value of preventing disease
  add_dsa_variable("c_sick", low = 10000, high = 40000,
                   display_name = "Cost of illness") %>%

  # 6. Sick utility - affects QALY gains from preventing disease
  add_dsa_variable("u_sick", low = 0.3, high = 0.7,
                   display_name = "Sick utility") %>%

  # Transitions - cost_adjust worsens treatment, identical_factor neutralizes it
  add_transition("healthy", "sick",
    "p_sick * (tx_effect + cost_adjust * 0.8 + identical_factor * (1 - tx_effect - cost_adjust * 0.8))") %>%
  add_transition("healthy", "dead", "p_death") %>%
  add_transition("healthy", "healthy",
    "1 - p_sick * (tx_effect + cost_adjust * 0.8 + identical_factor * (1 - tx_effect - cost_adjust * 0.8)) - p_death") %>%
  add_transition("sick", "dead", "0.15") %>%
  add_transition("sick", "sick", "0.85") %>%
  add_transition("dead", "dead", "1") %>%

  # Values - cost_adjust reduces cost, identical_factor neutralizes cost difference
  add_value("cost", "c_healthy + c_treatment * (1 - cost_adjust * 1.5) * (1 - identical_factor)", state = "healthy") %>%
  add_value("cost", "c_sick + c_treatment * (1 - cost_adjust * 1.5) * (1 - identical_factor)", state = "sick") %>%
  add_value("cost", "0", state = "dead") %>%
  add_value("qalys", "u_healthy", state = "healthy") %>%
  add_value("qalys", "u_sick", state = "sick") %>%
  add_value("qalys", "0", state = "dead") %>%

  add_summary("costs", "cost") %>%
  add_summary("qalys", "qalys", wtp = 100000)

standard_results <- run_dsa(standard_model)
```

```{r standard-plot, fig.width=10, fig.height=6}
dsa_ce_plot(
  standard_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

The table shows the same information without the axis constraint. Direction changes are shown with their ICER values and asterisks rather than being omitted, and "Identical" appears as text where the ICER is undefined.

```{r standard-table}
dsa_ce_table(
  standard_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

## Dominated Base Case

When the base case itself is dominated (intervention costlier and less effective), the plot cannot show a finite base case ICER. The base case is marked as "Dominated" and variations that remain dominated show no bar (they're in the same position as the base case).

```{r dominated-model, include = FALSE}
# Dominated base case: treatment costs MORE and is LESS effective
# Model structured so DSA can flip CE status by varying single parameters

dominated_model <- define_model("markov") %>%
  set_settings(
    n_cycles = 10, timeframe = 10, timeframe_unit = "years",
    cycle_length = 1, cycle_length_unit = "years"
  ) %>%
  add_strategy("control", "Standard Care") %>%
  add_strategy("treatment", "Inferior Treatment") %>%
  add_state("healthy", initial_prob = 1) %>%
  add_state("sick", initial_prob = 0) %>%
  add_state("dead", initial_prob = 0) %>%

  # Disease progression - p_death varies by strategy to allow mortality benefit DSA
  add_variable("p_sick", 0.15) %>%
  add_variable("p_death", 0.03, strategy = "control") %>%
  add_variable("p_death", 0.031, strategy = "treatment") %>%  # Treatment starts with slight mortality penalty

  # Treatment effect - MARGINALLY less effective (1.05 > 1.0)
  # Very close to boundary so multiple DSA parameters can flip to NE quadrant

  add_variable("tx_effect", 1.0, strategy = "control") %>%
  add_variable("tx_effect", 1.05, strategy = "treatment") %>%

  # Treatment cost per cycle - treatment significantly costlier
  # Very low state costs so treatment's direct cost dominates over any disease savings
  add_variable("c_treatment", 500, strategy = "control") %>%
  add_variable("c_treatment", 5000, strategy = "treatment") %>%

  # State costs - VERY low sick costs so treatment cost difference is what matters
  add_variable("c_healthy", 200) %>%
  add_variable("c_sick", 1500) %>%

  # Utility bonus for treatment - starts at 0, DSA can make it positive or negative
  add_variable("u_bonus", 0, strategy = "control") %>%
  add_variable("u_bonus", -0.02, strategy = "treatment") %>%  # Starts slightly negative

  # Healthy utility - strategy specific to allow DSA to vary treatment utility
  add_variable("u_healthy", 0.9, strategy = "control") %>%
  add_variable("u_healthy", 0.9, strategy = "treatment") %>%
  add_variable("u_sick", 0.4) %>%

  # DSA parameters - ranges chosen to create diverse outcomes from dominated base
  # Multiple parameters can push into NE quadrant (costlier + more effective)
  add_dsa_variable("tx_effect", low = 0.3, high = 1.5,
                   display_name = "Treatment effect", strategy = "treatment") %>%
  add_dsa_variable("tx_effect", low = 0.6, high = 1.5,
                   display_name = "Control effectiveness", strategy = "control") %>%
  add_dsa_variable("c_treatment", low = 2500, high = 8000,
                   display_name = "Treatment cost", strategy = "treatment") %>%
  add_dsa_variable("c_treatment", low = 200, high = 1500,
                   display_name = "Control therapy cost", strategy = "control") %>%
  add_dsa_variable("u_bonus", low = -0.2, high = 0.2,
                   display_name = "Treatment utility bonus", strategy = "treatment") %>%
  add_dsa_variable("p_death", low = 0.005, high = 0.08,
                   display_name = "Treatment mortality", strategy = "treatment") %>%
  add_dsa_variable("p_sick", low = 0.03, high = 0.35,
                   display_name = "Disease incidence") %>%
  add_dsa_variable("c_sick", low = 500, high = 4000,
                   display_name = "Cost of illness") %>%
  add_dsa_variable("u_sick", low = 0.2, high = 0.6,
                   display_name = "Sick utility") %>%

  # Transitions
  add_transition("healthy", "sick", "p_sick * tx_effect") %>%
  add_transition("healthy", "dead", "p_death") %>%
  add_transition("healthy", "healthy", "1 - p_sick * tx_effect - p_death") %>%
  add_transition("sick", "dead", "0.15") %>%
  add_transition("sick", "sick", "0.85") %>%
  add_transition("dead", "dead", "1") %>%

  # Values - utility bonus affects QALYs but not costs
  add_value("cost", "c_healthy + c_treatment", state = "healthy") %>%
  add_value("cost", "c_sick + c_treatment", state = "sick") %>%
  add_value("cost", "0", state = "dead") %>%
  add_value("qalys", "u_healthy + u_bonus", state = "healthy") %>%
  add_value("qalys", "u_sick + u_bonus", state = "sick") %>%
  add_value("qalys", "0", state = "dead") %>%

  add_summary("costs", "cost") %>%
  add_summary("qalys", "qalys", wtp = 100000)

dominated_results <- run_dsa(dominated_model)
```

```{r dominated-plot, fig.width=10, fig.height=7}
dsa_ce_plot(
  dominated_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

The table shows "Dominated" for the base case and any variations that remain dominated.

```{r dominated-table}
dsa_ce_table(
  dominated_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

## Dominant Base Case

When the base case itself is dominant (intervention cheaper and more effective), the plot cannot show a finite base case ICER. The base case is marked as "Dominant" and variations that remain dominant show no bar.

```{r dominant-model, include = FALSE}
# Dominant base case: treatment costs LESS and is MORE effective
# Model structured so DSA can flip CE status by varying single parameters

dominant_model <- define_model("markov") %>%
  set_settings(
    n_cycles = 10, timeframe = 10, timeframe_unit = "years",
    cycle_length = 1, cycle_length_unit = "years"
  ) %>%
  add_strategy("control", "Standard Care") %>%
  add_strategy("treatment", "Superior Treatment") %>%
  add_state("healthy", initial_prob = 1) %>%
  add_state("sick", initial_prob = 0) %>%
  add_state("dead", initial_prob = 0) %>%

  # Disease progression
  add_variable("p_sick", 0.15) %>%
  add_variable("p_death", 0.03) %>%

  # Treatment effect - MORE effective (0.6 < 1.0 means less disease progression)
  # Closer to boundary so DSA can flip to standard/dominated
  add_variable("tx_effect", 1.0, strategy = "control") %>%
  add_variable("tx_effect", 0.6, strategy = "treatment") %>%

  # Treatment cost - treatment is BARELY cheaper than control (tight margin)
  # Lower sick costs means effectiveness savings are smaller, making dominance marginal
  add_variable("c_treatment", 3500, strategy = "control") %>%
  add_variable("c_treatment", 3000, strategy = "treatment") %>%

  # State costs - moderate sick costs so dominance is marginal
  add_variable("c_healthy", 500) %>%
  add_variable("c_sick", 6000) %>%
  add_variable("u_healthy", 0.9) %>%
  add_variable("u_sick", 0.5) %>%

  # Utility bonus for treatment (starts at small positive, can be varied)
  add_variable("u_bonus", 0, strategy = "control") %>%
  add_variable("u_bonus", 0.02, strategy = "treatment") %>%

  # DSA parameters - ranges chosen to create diverse outcomes from dominant base
  # including multiple variations that reach NE quadrant (costlier + more effective)
  # Key insight: treatment cost can easily flip above control's 3500
  add_dsa_variable("tx_effect", low = 0.4, high = 1.3,
                   display_name = "Treatment effect", strategy = "treatment") %>%
  add_dsa_variable("tx_effect", low = 0.7, high = 1.3,
                   display_name = "Control effectiveness", strategy = "control") %>%
  add_dsa_variable("c_treatment", low = 1500, high = 10000,
                   display_name = "Treatment cost", strategy = "treatment") %>%
  add_dsa_variable("c_treatment", low = 1000, high = 6000,
                   display_name = "Control therapy cost", strategy = "control") %>%
  add_dsa_variable("u_bonus", low = -0.1, high = 0.1,
                   display_name = "Treatment utility bonus", strategy = "treatment") %>%
  add_dsa_variable("p_sick", low = 0.05, high = 0.30,
                   display_name = "Disease incidence") %>%
  add_dsa_variable("c_sick", low = 2000, high = 15000,
                   display_name = "Cost of illness") %>%
  add_dsa_variable("u_sick", low = 0.3, high = 0.7,
                   display_name = "Sick utility") %>%

  # Transitions
  add_transition("healthy", "sick", "p_sick * tx_effect") %>%
  add_transition("healthy", "dead", "p_death") %>%
  add_transition("healthy", "healthy", "1 - p_sick * tx_effect - p_death") %>%
  add_transition("sick", "dead", "0.15") %>%
  add_transition("sick", "sick", "0.85") %>%
  add_transition("dead", "dead", "1") %>%

  # Values - utility bonus affects QALYs but not costs
  add_value("cost", "c_healthy + c_treatment", state = "healthy") %>%
  add_value("cost", "c_sick + c_treatment", state = "sick") %>%
  add_value("cost", "0", state = "dead") %>%
  add_value("qalys", "u_healthy + u_bonus", state = "healthy") %>%
  add_value("qalys", "u_sick + u_bonus", state = "sick") %>%
  add_value("qalys", "0", state = "dead") %>%

  add_summary("costs", "cost") %>%
  add_summary("qalys", "qalys", wtp = 100000)

dominant_results <- run_dsa(dominant_model)
```

```{r dominant-plot, fig.width=10, fig.height=7}
dsa_ce_plot(
  dominant_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

The table shows "Dominant" for the base case and any variations that remain dominant.

```{r dominant-table}
dsa_ce_table(
  dominant_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

## Identical Base Case

When the base case has identical costs and outcomes between strategies, no ICER can be computed and no tornado plot can be displayed.

```{r identical-model, include = FALSE}
# Identical base case: treatment and control are the same
# All variables strategy-specific so DSA can create differences from identical base

identical_model <- define_model("markov") %>%
  set_settings(
    n_cycles = 10, timeframe = 10, timeframe_unit = "years",
    cycle_length = 1, cycle_length_unit = "years"
  ) %>%
  add_strategy("control", "Standard Care") %>%
  add_strategy("treatment", "Identical Treatment") %>%
  add_state("healthy", initial_prob = 1) %>%
  add_state("sick", initial_prob = 0) %>%
  add_state("dead", initial_prob = 0) %>%

  # Disease progression
  add_variable("p_sick", 0.15) %>%
  add_variable("p_death", 0.03) %>%

  # Treatment effect - IDENTICAL (both 1.0)
  add_variable("tx_effect", 1.0, strategy = "control") %>%
  add_variable("tx_effect", 1.0, strategy = "treatment") %>%

  # Treatment cost - IDENTICAL (both 0)
  add_variable("c_treatment", 0, strategy = "control") %>%
  add_variable("c_treatment", 0, strategy = "treatment") %>%

  # State costs - strategy-specific so DSA can create differences
  add_variable("c_healthy", 500) %>%
  add_variable("c_sick", 20000, strategy = "control") %>%
  add_variable("c_sick", 20000, strategy = "treatment") %>%
  add_variable("u_healthy", 0.9) %>%
  add_variable("u_sick", 0.5, strategy = "control") %>%
  add_variable("u_sick", 0.5, strategy = "treatment") %>%

  # DSA parameters - all target treatment strategy
  add_dsa_variable("tx_effect", low = 0.5, high = 1.5,
                   display_name = "Treatment effect", strategy = "treatment") %>%
  add_dsa_variable("c_treatment", low = 0, high = 10000,
                   display_name = "Treatment cost", strategy = "treatment") %>%
  add_dsa_variable("c_sick", low = 10000, high = 40000,
                   display_name = "Cost of illness", strategy = "treatment") %>%
  add_dsa_variable("u_sick", low = 0.3, high = 0.7,
                   display_name = "Sick utility", strategy = "treatment") %>%

  add_transition("healthy", "sick", "p_sick * tx_effect") %>%
  add_transition("healthy", "dead", "p_death") %>%
  add_transition("healthy", "healthy", "1 - p_sick * tx_effect - p_death") %>%
  add_transition("sick", "dead", "0.15") %>%
  add_transition("sick", "sick", "0.85") %>%
  add_transition("dead", "dead", "1") %>%

  add_value("cost", "c_healthy + c_treatment", state = "healthy") %>%
  add_value("cost", "c_sick + c_treatment", state = "sick") %>%
  add_value("cost", "0", state = "dead") %>%
  add_value("qalys", "u_healthy", state = "healthy") %>%
  add_value("qalys", "u_sick", state = "sick") %>%
  add_value("qalys", "0", state = "dead") %>%

  add_summary("costs", "cost") %>%
  add_summary("qalys", "qalys", wtp = 100000)

identical_results <- run_dsa(identical_model)
```

```{r identical-plot, fig.width=10, fig.height=5, error=TRUE}
dsa_ce_plot(
  identical_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

The table similarly cannot display meaningful ICER values when the base case is identical.

```{r identical-table}
dsa_ce_table(
  identical_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

## Flipped Base Case

When the base case is in the southwest quadrant (intervention cheaper but less effective), the requested comparison cannot be shown. Instead, the plot displays the reverse comparison.

```{r flipped-model, include = FALSE}
# Flipped base case: treatment is CHEAPER but LESS effective
# This puts the base case in the southwest quadrant

flipped_model <- define_model("markov") %>%
  set_settings(
    n_cycles = 10, timeframe = 10, timeframe_unit = "years",
    cycle_length = 1, cycle_length_unit = "years"
  ) %>%
  add_strategy("control", "Standard Care") %>%
  add_strategy("treatment", "Budget Treatment") %>%
  add_state("healthy", initial_prob = 1) %>%
  add_state("sick", initial_prob = 0) %>%
  add_state("dead", initial_prob = 0) %>%

  # Disease progression
  add_variable("p_sick", 0.15) %>%
  add_variable("p_death", 0.03) %>%

  # Treatment effect - budget treatment is LESS effective (higher multiplier)
  add_variable("tx_effect", 1.0, strategy = "control") %>%
  add_variable("tx_effect", 1.3, strategy = "treatment") %>%

  # Treatment cost - budget treatment is CHEAPER
  add_variable("c_treatment", 5000, strategy = "control") %>%
  add_variable("c_treatment", 1000, strategy = "treatment") %>%

  # State costs and utilities
  add_variable("c_healthy", 500) %>%
  add_variable("c_sick", 3000) %>%
  add_variable("u_healthy", 0.9) %>%
  add_variable("u_sick", 0.5) %>%

  # DSA parameters
  add_dsa_variable("tx_effect", low = 0.8, high = 1.6,
                   display_name = "Treatment effect", strategy = "treatment") %>%
  add_dsa_variable("c_treatment", low = 500, high = 3000,
                   display_name = "Treatment cost", strategy = "treatment") %>%
  add_dsa_variable("c_sick", low = 1000, high = 8000,
                   display_name = "Cost of illness") %>%
  add_dsa_variable("c_healthy", low = 200, high = 1000,
                   display_name = "Healthy state cost") %>%
  add_dsa_variable("u_healthy", low = 0.8, high = 1.0,
                   display_name = "Healthy utility") %>%
  add_dsa_variable("u_sick", low = 0.3, high = 0.7,
                   display_name = "Sick utility") %>%

  # Transitions
  add_transition("healthy", "sick", "p_sick * tx_effect") %>%
  add_transition("healthy", "dead", "p_death") %>%
  add_transition("healthy", "healthy", "1 - p_sick * tx_effect - p_death") %>%
  add_transition("sick", "dead", "0.15") %>%
  add_transition("sick", "sick", "0.85") %>%
  add_transition("dead", "dead", "1") %>%

  # Values
  add_value("cost", "c_healthy + c_treatment", state = "healthy") %>%
  add_value("cost", "c_sick + c_treatment", state = "sick") %>%
  add_value("cost", "0", state = "dead") %>%
  add_value("qalys", "u_healthy", state = "healthy") %>%
  add_value("qalys", "u_sick", state = "sick") %>%
  add_value("qalys", "0", state = "dead") %>%

  add_summary("costs", "cost") %>%
  add_summary("qalys", "qalys", wtp = 100000)

flipped_results <- run_dsa(flipped_model)
```

```{r flipped-plot, fig.width=10, fig.height=6}
dsa_ce_plot(
  flipped_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

Note the asterisks and footnote: because the "treatment vs control" ICER cannot be computed (treatment is cheaper but less effective), the plot shows "control vs treatment" instead. All values are marked with asterisks to indicate this reversal.

The table handles this differently. Because it is not constrained to a single axis, it can show each ICER value in its natural direction without needing to flip the entire comparison. Asterisks indicate when a value's comparison direction differs from the requested direction.

```{r flipped-table}
dsa_ce_table(
  flipped_results,
  health_outcome = "qalys",
  cost_outcome = "costs",
  interventions = "treatment",
  comparators = "control"
)
```

