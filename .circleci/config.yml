version: 2.1

jobs:
  build_and_test:
    docker:
      - image: rocker/verse:latest
    environment:
      R_LIBS_USER: /home/rstudio/R/Library
    steps:
      - checkout
      - restore_cache:
          keys:
            - r-pkg-cache-{{ arch }}-{{ checksum "DESCRIPTION" }}
            - r-pkg-cache-{{ arch }}-
      - run:
          name: Install dependencies via pak (Binaries)
          command: |
            mkdir -p ${R_LIBS_USER}
            Rscript -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/bookworm/latest"))'
            Rscript -e 'if (!requireNamespace("pak", quietly = TRUE)) install.packages("pak")'
            Rscript -e 'pak::pkg_install(c("PolicyAnalysisInc/openqalytools", "PolicyAnalysisInc/openqalysurv", "rcmdcheck", "sessioninfo"))'
            Rscript -e 'pak::local_install_deps(dependencies = TRUE)'
      - save_cache:
          key: r-pkg-cache-{{ arch }}-{{ checksum "DESCRIPTION" }}
          paths:
            - "/home/rstudio/R/Library"
      - run:
          name: Build and Check package
          no_output_timeout: 20m
          command: |
            R CMD build .
            R CMD check --as-cran --no-manual *tar.gz
      - store_artifacts:
          path: openqaly.Rcheck/

  build_and_coverage:
    docker:
      - image: rocker/verse:latest
    environment:
      R_LIBS_USER: /home/rstudio/R/Library
    steps:
      - checkout
      - restore_cache:
          keys:
            - r-pkg-cache-{{ arch }}-{{ checksum "DESCRIPTION" }}
            - r-pkg-cache-{{ arch }}-
      - run:
          name: Install dependencies
          command: |
            mkdir -p ${R_LIBS_USER}
            Rscript -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/bookworm/latest"))'
            Rscript -e 'if (!requireNamespace("pak", quietly = TRUE)) install.packages("pak")'
            Rscript -e 'pak::pkg_install(c("PolicyAnalysisInc/openqalytools", "PolicyAnalysisInc/openqalysurv", "covr"))'
            Rscript -e 'pak::local_install_deps(dependencies = TRUE)'
      - run:
          name: Code Coverage
          # Increased timeout to prevent CircleCI from killing the job during long tests/compilation
          no_output_timeout: 30m 
          command: |
            # Clean up any existing objects to ensure a fresh instrumented build
            Rscript -e 'covr::codecov(quiet = FALSE, clean = FALSE)'

workflows:
  version: 2
  build:
    jobs:
      - build_and_test
      - build_and_coverage